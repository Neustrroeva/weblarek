(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class m{_events;constructor(){this._events=new Map}on(t,e){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(e)}off(t,e){this._events.has(t)&&(this._events.get(t).delete(e),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,e){this._events.forEach((i,s)=>{s==="*"&&i.forEach(o=>o({eventName:t,data:e})),(s instanceof RegExp&&s.test(t)||s===t)&&i.forEach(o=>o(e))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,e){return(i={})=>{this.emit(t,{...i||{},...e||{}})}}}class y{baseUrl;options;constructor(t,e={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...e.headers??{}},...e}}async request(t,e={}){const i=this.baseUrl+t,s=await fetch(i,{...this.options,...e,headers:{"Content-Type":"application/json",...this.options.headers||{},...e.headers||{}}});if(!s.ok){let o={status:s.status,statusText:s.statusText};try{const r=await s.json();typeof r=="object"&&(o={...o,...r})}catch{}throw o}if(s.status!==204)return await s.json()}get(t){return this.request(t,{method:"GET"})}post(t,e,i="POST"){return this.request(t,{method:i,body:e===void 0?void 0:JSON.stringify(e)})}}const f=6,g=[{id:"p-101",title:"Наклейки «JS/TS»",description:"Виниловые стикеры на ноутбук и блокнот",category:"дополнительное",image:"/25hours.png",price:199},{id:"p-102",title:"Пин «Кот-разработчик»",description:"Эмалированный пин для рюкзака",category:"другое",image:"/backend-antistress.png",price:299},{id:"p-103",title:"Кнопка «Deploy»",description:"Нажми и… ничего не сломай",category:"кнопка",image:"/bem.png",price:null},{id:"p-104",title:"Постер «Сильная типизация»",description:"Типы — это любовь",category:"хард-скил",image:"/fate-cookie.png",price:499},{id:"p-105",title:"Книга «Гид по событиям»",description:"Правильная шина событий и слабые связи",category:"софт-скил",image:"/hex-candy.png",price:799},{id:"p-106",title:"Носки «БЭМ & SCSS»",description:"Стильно, модно, многослойно",category:"другое",image:"/micro-universe.png",price:399}],b={total:f,items:g};function v(n){return n.endsWith("/")?n.slice(0,-1):n}class _ extends y{resolved=null;prefixes;resources=["/products","/items","/catalog"];constructor(t,e={}){const i=v(t||"");super(i,e),this.prefixes=i.endsWith("/api/weblarek")?["","/api","/weblarek"]:["/api/weblarek","","/api","/weblarek"]}async tryCombinations(t){const e=this.resolved?[this.resolved]:this.prefixes.flatMap(s=>this.resources.map(o=>({prefix:s,resource:o})));let i;for(const{prefix:s,resource:o}of e)try{const r=await t(`${s}${o}`);return this.resolved={prefix:s,resource:o},{data:r,prefix:s,resource:o}}catch(r){i=r;const l=r?.status??r?.code,a=(r?.statusText||r?.message||"").toString().toLowerCase();if(!(l===404||a.includes("not found")))throw r}throw i??new Error("No working API path found")}async getProducts(){try{const{data:t}=await this.tryCombinations(e=>this.get(e));return t}catch{return b}}createOrder(t){const e=this.resolved?.prefix??this.prefixes[0];return this.post(`${e}/orders`,t,"POST")}}class k{constructor(t){this.events=t}items=[];get state(){return{items:this.items.slice(),total:this.items.reduce((t,e)=>t+(e.price??0),0)}}has(t){return this.items.some(e=>e.id===t)}add(t){if(this.has(t.id))return;const e={id:t.id,title:t.title,price:t.price};this.items.push(e),this.emitUpdated()}remove(t){this.items=this.items.filter(e=>e.id!==t),this.emitUpdated()}clear(){this.items=[],this.emitUpdated()}emitUpdated(){this.events.emit("basket:updated",{state:this.state})}}class S{constructor(t){this.events=t}step1={payment:null,address:""};step2={email:"",phone:""};setStep1(t){this.step1={...this.step1,...t};const e=this.validateStep1();return this.publishValidation(1,e),e}setStep2(t){this.step2={...this.step2,...t};const e=this.validateStep2();return this.publishValidation(2,e),e}toRequest(t,e){return{...this.step1,...this.step2,items:t,total:e}}reset(){this.step1={payment:null,address:""},this.step2={email:"",phone:""}}publishValidation(t,e){this.events.emit("form:errors",{errors:e.errors}),this.events.emit("form:valid",{step:t,isValid:e.valid})}validateStep1(){const t={};return this.step1.address?.trim()||(t.address="Укажите адрес"),this.step1.payment||(t.payment="Выберите способ оплаты"),{valid:Object.keys(t).length===0,errors:t}}validateStep2(){const t={};return this.step2.email?.trim()||(t.email="Укажите email"),this.step2.phone?.trim()||(t.phone="Укажите телефон"),{valid:Object.keys(t).length===0,errors:t}}}function c(n){const t=document.getElementById(n);if(!t)throw new Error(`Не найден template#${n}`);return t.content.firstElementChild.cloneNode(!0)}function u(n,t){n.toggleAttribute("disabled",t)}function h(n){return n==null?"Недоступно":`${new Intl.NumberFormat("ru-RU").format(n)} синапсов`}class E{constructor(t){this.events=t,this.root=c("card-catalog"),this.root.addEventListener("click",()=>{this.productId&&this.events.emit("product:select",{id:this.productId})})}root;productId;render(t){this.productId=t.id,this.root.querySelector(".card__title").textContent=t.title,this.root.querySelector(".card__price").textContent=h(t.price);const e=this.root.querySelector(".card__category");e.textContent=t.category,e.className=`card__category card__category_${this.getCategoryClass(t.category)}`;const i=this.root.querySelector(".card__image");return i.src=t.image,i.alt=t.title,this.root}getCategoryClass(t){return{"софт-скил":"soft",другое:"other",дополнительное:"additional",кнопка:"button","хард-скил":"hard"}[t]||"other"}}class w{root;events;listEl;basketBtn;counterEl;constructor(t,e){this.root=t,this.events=e,this.listEl=t,this.basketBtn=document.querySelector(".header__basket"),this.counterEl=document.querySelector(".header__basket-counter"),this.basketBtn.addEventListener("click",()=>this.events.emit("basket:open")),e.on("items:change",i=>{const{items:s}=i;this.render(s)}),e.on("basket:updated",i=>{const{state:s}=i;this.counterEl.textContent=String(s.items.length)})}render(t){const e=t.map(i=>new E(this.events).render(i));this.listEl.replaceChildren(...e)}}class B{constructor(t){this.events=t,this.root=c("card-preview"),this.buyBtn=this.root.querySelector(".card__button")}root;currentProduct=null;buyBtn;render(t,e){if(this.currentProduct=t,!this.root.querySelector(".card__media")){const a=this.root.querySelector(".card__image");if(a){const d=document.createElement("div");d.className="card__media",a.replaceWith(d),d.appendChild(a)}}this.root.querySelector(".card__title").textContent=t.title,this.root.querySelector(".card__price").textContent=h(t.price);const s=this.root.querySelector(".card__category");s.textContent=t.category,s.className=`card__category card__category_${this.getCategoryClass(t.category)}`;const o=this.root.querySelector(".card__image");o.src=t.image,o.alt=t.title;const r=this.root.querySelector(".card__text");return r&&(r.textContent=t.description||""),t.price===null?(this.buyBtn.textContent="Недоступно",u(this.buyBtn,!0)):this.updateButton(e),this.root}updateButton(t){this.currentProduct&&(this.buyBtn.disabled=!1,this.buyBtn.onclick=null,t?(this.buyBtn.textContent="Удалить из корзины",this.buyBtn.onclick=()=>{this.currentProduct&&(this.events.emit("basket:remove",{id:this.currentProduct.id}),this.updateButton(!1))}):(this.buyBtn.textContent="Купить",this.buyBtn.onclick=()=>{this.currentProduct&&(this.events.emit("basket:add",{id:this.currentProduct.id}),this.updateButton(!0))}))}getCategoryClass(t){return{"софт-скил":"soft",другое:"other",дополнительное:"additional",кнопка:"button","хард-скил":"hard"}[t]||"other"}}class C{constructor(t){this.events=t,this.root=c("basket"),this.listEl=this.root.querySelector(".basket__list"),this.totalEl=this.root.querySelector(".basket__price"),this.buttonEl=this.root.querySelector(".basket__button"),this.emptyEl=this.root.querySelector(".basket__empty-text"),this.buttonEl.addEventListener("click",()=>this.events.emit("order:open-step1"))}root;listEl;totalEl;buttonEl;emptyEl;render(t,e){const i=t.length===0;return this.listEl.replaceChildren(...t.map((s,o)=>{const r=c("card-basket");return r.querySelector(".basket__item-index").textContent=String(o+1),r.querySelector(".basket__item-title").textContent=s.title,r.querySelector(".basket__item-price").textContent=h(s.price),r.querySelector(".basket__item-delete").addEventListener("click",()=>{this.events.emit("basket:remove",{id:s.id})}),r})),this.totalEl.textContent=h(e),this.emptyEl.style.display=i?"block":"none",this.listEl.style.display=i?"none":"flex",u(this.buttonEl,i),this.root}}class q{constructor(t){this.events=t,this.root=c("order"),this.addressInput=this.root.querySelector('input[name="address"]'),this.paymentCardBtn=this.root.querySelector('button[name="card"]'),this.paymentCashBtn=this.root.querySelector('button[name="cash"]'),this.nextBtn=this.root.querySelector(".order__button"),this.errorsEl=this.root.querySelector(".form__errors"),this.addressInput.addEventListener("input",()=>this.validateForm()),this.paymentCardBtn.addEventListener("click",()=>this.togglePayment("card")),this.paymentCashBtn.addEventListener("click",()=>this.togglePayment("cash")),this.nextBtn.addEventListener("click",e=>{e.preventDefault(),this.submitForm()})}root;addressInput;paymentCardBtn;paymentCashBtn;nextBtn;errorsEl;mount(t){return this.addressInput.value=t.address??"",this.setActivePayment(t.payment??null),this.validateForm(),this.root}togglePayment(t){const i=this.getActivePayment()===t?null:t;this.setActivePayment(i),this.validateForm()}setActivePayment(t){this.paymentCardBtn.classList.toggle("button_alt-active",t==="card"),this.paymentCashBtn.classList.toggle("button_alt-active",t==="cash")}getActivePayment(){return this.paymentCardBtn.classList.contains("button_alt-active")?"card":this.paymentCashBtn.classList.contains("button_alt-active")?"cash":null}validateForm(){const t=this.addressInput.value.trim(),e=this.getActivePayment(),i=t.length>=5,s=e!==null,o=i&&s;u(this.nextBtn,!o),s?i?this.errorsEl.textContent="":this.errorsEl.textContent="Необходимо указать адрес":this.errorsEl.textContent="Необходимо выбрать способ оплаты"}submitForm(){const t=this.addressInput.value.trim(),e=this.getActivePayment();e&&t.length>=5?this.events.emit("order:fill-step1",{payment:e,address:t}):this.validateForm()}}class x{constructor(t,e){this.events=t,this.onSubmit=e,this.root=c("contacts"),this.emailInput=this.root.querySelector('input[name="email"]'),this.phoneInput=this.root.querySelector('input[name="phone"]'),this.payBtn=this.root.querySelector(".button"),this.errorsEl=this.root.querySelector(".form__errors"),this.emailInput.addEventListener("input",()=>this.validateForm()),this.phoneInput.addEventListener("input",()=>this.validateForm()),this.payBtn.addEventListener("click",i=>{i.preventDefault(),this.submitForm()})}root;emailInput;phoneInput;payBtn;errorsEl;mount(t){return this.emailInput.value=t.email??"",this.phoneInput.value=t.phone??"",this.validateForm(),this.root}validateForm(){const t=this.emailInput.value.trim(),e=this.phoneInput.value.trim(),i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),s=/^[\+]?[0-9\s\-\(\)]{10,}$/.test(e),o=i&&s;u(this.payBtn,!o);const r=[];!i&&t.length>0&&r.push("Введите корректный email"),!s&&e.length>0&&r.push("Введите корректный номер телефона"),this.errorsEl.textContent=r.join(", ")}submitForm(){const t=this.emailInput.value.trim(),e=this.phoneInput.value.trim(),i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),s=/^[\+]?[0-9\s\-\(\)]{10,}$/.test(e);i&&s&&(this.events.emit("order:fill-step2",{email:t,phone:e}),this.onSubmit())}}class P{constructor(t){this.onClose=t,this.root=c("success"),this.descEl=this.root.querySelector(".order-success__description"),this.closeBtn=this.root.querySelector(".order-success__close"),this.closeBtn.addEventListener("click",()=>this.onClose())}root;descEl;closeBtn;mount(t){return this.descEl.textContent=t,this.root}}class V{constructor(t){this.events=t,this.root=document.querySelector(".modal"),this.content=this.root.querySelector(".modal__content"),this.closeBtn=this.root.querySelector(".modal__close"),this.root.addEventListener("click",this.onBackdrop),this.closeBtn.addEventListener("click",()=>this.close()),t.on("modal:open",e=>{const{content:i}=e;this.open(i)}),t.on("modal:close",()=>this.close())}root;content;closeBtn;onBackdrop=t=>{t.target===this.root&&this.close()};lockBodyScroll(){document.body.style.overflow="hidden"}unlockBodyScroll(){document.body.style.overflow=""}open(t){this.content.replaceChildren(t),t.classList.contains("basket")?this.root.classList.add("modal_basket"):this.root.classList.remove("modal_basket"),this.root.classList.add("modal_active"),this.lockBodyScroll()}close(){this.root.classList.remove("modal_active","modal_basket"),this.content.replaceChildren(),this.unlockBodyScroll()}}class I{constructor(t,e,i){this.api=t,this.events=e,this.basket=new k(e),this.order=new S(e),this.mainView=new w(i,e),this.modal=new V(e),this.loadProducts(),e.on("product:select",({id:s})=>{const o=this.products.find(a=>a.id===s);if(!o)return;const l=new B(e).render(o,this.basket.has(s));this.openBasketView=null,e.emit("modal:open",{content:l})}),e.on("basket:open",()=>this.openBasket()),e.on("basket:add",({id:s})=>{const o=this.products.find(r=>r.id===s);o&&this.basket.add(o)}),e.on("basket:remove",({id:s})=>{this.basket.remove(s)}),e.on("basket:updated",({state:s})=>{if(this.openBasketView){const o=this.openBasketView.render(s.items,s.total);this.modal.open(o)}}),e.on("modal:close",()=>this.openBasketView=null),e.on("order:open-step1",()=>{const s=new q(e);this.openBasketView=null,this.modal.open(s.mount(this.order.step1))}),e.on("order:fill-step1",s=>{const o=s;if(this.order.step1={payment:o.payment,address:o.address??""},o.address?.trim().length>0&&(o.payment==="card"||o.payment==="cash")){const l=new x(e,()=>this.submitOrder());this.modal.open(l.mount(this.order.step2))}}),e.on("order:fill-step2",s=>{this.order.step2={email:s.email??"",phone:s.phone??""},this.submitOrder()}),e.on("order:success",({total:s})=>{this.basket.clear(),this.order.reset();const o=new P(()=>e.emit("modal:close"));this.openBasketView=null,this.modal.open(o.mount(`Списано ${h(s)}`))})}products=[];mainView;basket;order;modal;openBasketView=null;openBasket(){const t=new C(this.events),{items:e,total:i}=this.basket.state;this.openBasketView=t,this.events.emit("modal:open",{content:t.render(e,i)})}async loadProducts(){try{const t=await this.api.getProducts();this.products=t.items,this.events.emit("items:change",{items:this.products})}catch(t){console.error(t)}}async submitOrder(){const{items:t,total:e}=this.basket.state,i=this.order.toRequest(t.map(s=>s.id),e);try{await this.api.createOrder(i),this.events.emit("order:success",{total:i.total})}catch(s){console.error(s),this.events.emit("order:success",{total:i.total})}}}const L="",O=document.querySelector("main.gallery"),p=new m,F=new _(L);new I(F,p,O);p.emit("app:init");
//# sourceMappingURL=index-EHxJdv5e.js.map
