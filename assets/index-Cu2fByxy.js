(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class m{_events;constructor(){this._events=new Map}on(t,e){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(e)}off(t,e){this._events.has(t)&&(this._events.get(t).delete(e),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,e){this._events.forEach((i,s)=>{s==="*"&&i.forEach(o=>o({eventName:t,data:e})),(s instanceof RegExp&&s.test(t)||s===t)&&i.forEach(o=>o(e))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,e){return(i={})=>{this.emit(t,{...i||{},...e||{}})}}}class y{baseUrl;options;constructor(t,e={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...e.headers??{}},...e}}async request(t,e={}){const i=this.baseUrl+t,s=await fetch(i,{...this.options,...e,headers:{"Content-Type":"application/json",...this.options.headers||{},...e.headers||{}}});if(!s.ok){let o={status:s.status,statusText:s.statusText};try{const r=await s.json();typeof r=="object"&&(o={...o,...r})}catch{}throw o}if(s.status!==204)return await s.json()}get(t){return this.request(t,{method:"GET"})}post(t,e,i="POST"){return this.request(t,{method:i,body:e===void 0?void 0:JSON.stringify(e)})}}const f=6,v=[{id:"p-101",title:"Наклейки «JS/TS»",description:"Виниловые стикеры на ноутбук и блокнот",category:"дополнительное",image:"/25hours.png",price:199},{id:"p-102",title:"Пин «Кот-разработчик»",description:"Эмалированный пин для рюкзака",category:"другое",image:"/backend-antistress.png",price:299},{id:"p-103",title:"Кнопка «Deploy»",description:"Нажми и… ничего не сломай",category:"кнопка",image:"/bem.png",price:null},{id:"p-104",title:"Постер «Сильная типизация»",description:"Типы — это любовь",category:"хард-скил",image:"/fate-cookie.png",price:499},{id:"p-105",title:"Книга «Гид по событиям»",description:"Правильная шина событий и слабые связи",category:"софт-скил",image:"/hex-candy.png",price:799},{id:"p-106",title:"Носки «БЭМ & SCSS»",description:"Стильно, модно, многослойно",category:"другое",image:"/micro-universe.png",price:399}],b={total:f,items:v};function g(n){return n.endsWith("/")?n.slice(0,-1):n}class _ extends y{resolved=null;prefixes;resources=["/products","/items","/catalog"];constructor(t,e={}){const i=g(t||"");super(i,e),this.prefixes=i.endsWith("/api/weblarek")?["","/api","/weblarek"]:["/api/weblarek","","/api","/weblarek"]}async tryCombinations(t){const e=this.resolved?[this.resolved]:this.prefixes.flatMap(s=>this.resources.map(o=>({prefix:s,resource:o})));let i;for(const{prefix:s,resource:o}of e)try{const r=await t(`${s}${o}`);return this.resolved={prefix:s,resource:o},{data:r,prefix:s,resource:o}}catch(r){i=r;const a=r?.status??r?.code,d=(r?.statusText||r?.message||"").toString().toLowerCase();if(!(a===404||d.includes("not found")))throw r}throw i??new Error("No working API path found")}async getProducts(){try{const{data:t}=await this.tryCombinations(e=>this.get(e));return t}catch{return b}}createOrder(t){const e=this.resolved?.prefix??this.prefixes[0];return this.post(`${e}/orders`,t,"POST")}}class k{constructor(t){this.events=t}items=[];get state(){return{items:this.items.slice(),total:this.items.reduce((t,e)=>t+(e.price??0),0)}}has(t){return this.items.some(e=>e.id===t)}add(t){if(this.has(t.id))return;const e={id:t.id,title:t.title,price:t.price};this.items.push(e),this.emitUpdated()}remove(t){this.items=this.items.filter(e=>e.id!==t),this.emitUpdated()}clear(){this.items=[],this.emitUpdated()}emitUpdated(){this.events.emit("basket:updated",{state:this.state})}}class E{constructor(t){this.events=t}step1={payment:null,address:""};step2={email:"",phone:""};setStep1(t){this.step1={...this.step1,...t};const e=this.validateStep1();return this.publishValidation(1,e),e}setStep2(t){this.step2={...this.step2,...t};const e=this.validateStep2();return this.publishValidation(2,e),e}toRequest(t,e){return{...this.step1,...this.step2,items:t,total:e}}reset(){this.step1={payment:null,address:""},this.step2={email:"",phone:""}}publishValidation(t,e){this.events.emit("form:errors",{errors:e.errors}),this.events.emit("form:valid",{step:t,isValid:e.valid})}validateStep1(){const t={};return this.step1.address?.trim()||(t.address="Укажите адрес"),this.step1.payment||(t.payment="Выберите способ оплаты"),{valid:Object.keys(t).length===0,errors:t}}validateStep2(){const t={};return this.step2.email?.trim()||(t.email="Укажите email"),this.step2.phone?.trim()||(t.phone="Укажите телефон"),{valid:Object.keys(t).length===0,errors:t}}}function S(n){const t=document.getElementById(n);if(!t)throw new Error(`Не найден template#${n}`);return t.content.firstElementChild.cloneNode(!0)}function C(n,t){n.toggleAttribute("disabled",t)}class l{root;constructor(t){this.root=S(t)}setTextContent(t,e){const i=this.root.querySelector(t);i&&(i.textContent=e)}setDisplay(t,e){const i=this.root.querySelector(t);i&&(i.style.display=e)}setButtonDisabled(t,e){const i=this.root.querySelector(t);i&&C(i,e)}toggleClass(t,e,i){const s=this.root.querySelector(t);s&&s.classList.toggle(e,i)}addEventListener(t,e,i){const s=this.root.querySelector(t);s&&s.addEventListener(e,i)}setAttribute(t,e,i){const s=this.root.querySelector(t);s&&s.setAttribute(e,i)}setInputValue(t,e){const i=this.root.querySelector(t);i&&(i.value=e)}getInputValue(t){const e=this.root.querySelector(t);return e?e.value:""}hasClass(t,e){const i=this.root.querySelector(t);return i?i.classList.contains(e):!1}}function c(n){return n==null?"Недоступно":`${new Intl.NumberFormat("ru-RU").format(n)} синапсов`}class h extends l{constructor(t,e){super(t),this.events=e}currentProduct=null;setProductInfo(t){this.currentProduct=t,this.setTextContent(".card__title",t.title),this.setTextContent(".card__price",c(t.price)),this.setTextContent(".card__category",t.category),this.setCategoryClass(t.category),this.setImage(".card__image",t.image,t.title)}setCategoryClass(t){const e=this.getCategoryClass(t),i=this.root.querySelector(".card__category");i&&(i.className=`card__category card__category_${e}`)}setImage(t,e,i){const s=this.root.querySelector(t);s&&(s.src=e,s.alt=i)}getCategoryClass(t){return{"софт-скил":"soft",другое:"other",дополнительное:"additional",кнопка:"button","хард-скил":"hard"}[t]||"other"}getCurrentProduct(){return this.currentProduct}}class w extends h{constructor(t){super("card-catalog",t)}render(t){return this.setProductInfo(t),this.root}}class V{root;events;listEl;basketBtn;counterEl;constructor(t,e){this.root=t,this.events=e,this.listEl=t,this.basketBtn=document.querySelector(".header__basket"),this.counterEl=document.querySelector(".header__basket-counter"),this.setupEventListeners()}setupEventListeners(){this.basketBtn.addEventListener("click",()=>this.events.emit("basket:open")),this.listEl.addEventListener("click",t=>{const e=t.target.closest(".card");if(e){const i=e.getAttribute("data-product-id");i&&this.events.emit("product:select",{id:i})}}),this.events.on("items:change",t=>{const{items:e}=t;this.render(e)}),this.events.on("basket:updated",t=>{const{state:e}=t;this.counterEl.textContent=String(e.items.length)})}render(t){const e=t.map(i=>{const o=new w(this.events).render(i);return o.setAttribute("data-product-id",i.id),o});this.listEl.replaceChildren(...e)}}class B extends h{buyBtn;constructor(t){super("card-preview",t),this.buyBtn=this.root.querySelector(".card__button")}render(t,e){return this.ensureMediaWrapper(),this.setProductInfo(t),this.setTextContent(".card__text",t.description||""),this.updateButton(t.price===null,e),this.root}ensureMediaWrapper(){if(!this.root.querySelector(".card__media")){const e=this.root.querySelector(".card__image");if(e){const i=document.createElement("div");i.className="card__media",e.replaceWith(i),i.appendChild(e)}}}updateButton(t,e){t?(this.setTextContent(".card__button","Недоступно"),this.setButtonDisabled(".card__button",!0),this.buyBtn.onclick=null):(this.setButtonDisabled(".card__button",!1),this.setupButtonHandlers(e))}setupButtonHandlers(t){t?(this.setTextContent(".card__button","Удалить из корзины"),this.buyBtn.onclick=()=>{const e=this.getCurrentProduct();e&&(this.events.emit("basket:remove",{id:e.id}),this.setupButtonHandlers(!1))}):(this.setTextContent(".card__button","Купить"),this.buyBtn.onclick=()=>{const e=this.getCurrentProduct();e&&(this.events.emit("basket:add",{id:e.id}),this.setupButtonHandlers(!0))})}}class L extends l{constructor(t){super("card-basket"),this.events=t}render(t,e){return this.setTextContent(".basket__item-index",String(e+1)),this.setTextContent(".basket__item-title",t.title),this.setTextContent(".basket__item-price",c(t.price)),this.addEventListener(".basket__item-delete","click",()=>{this.events.emit("basket:remove",{id:t.id})}),this.root}}class q extends l{constructor(t){super("basket"),this.events=t,this.listEl=this.root.querySelector(".basket__list"),this.totalEl=this.root.querySelector(".basket__price"),this.buttonEl=this.root.querySelector(".basket__button"),this.emptyEl=this.root.querySelector(".basket__empty-text"),this.addEventListener(".basket__button","click",()=>this.events.emit("order:open-step1"))}listEl;totalEl;buttonEl;emptyEl;render(t,e){const i=t.length===0,s=t.map((o,r)=>new L(this.events).render(o,r));return this.listEl.replaceChildren(...s),this.setTextContent(".basket__price",c(e)),this.setDisplay(".basket__empty-text",i?"block":"none"),this.setDisplay(".basket__list",i?"none":"flex"),this.setButtonDisabled(".basket__button",i),this.root}}class u extends l{constructor(t,e){super(t),this.events=e,this.submitBtn=this.root.querySelector('button[type="submit"]'),this.errorsEl=this.root.querySelector(".form__errors"),this.setupFormEventListeners(),this.setupValidationListeners()}submitBtn;errorsEl;isFormValid=!1;setupFormEventListeners(){this.submitBtn&&this.submitBtn.addEventListener("click",t=>{t?.preventDefault(),this.handleSubmit()}),this.setupInputChangeListeners()}setupValidationListeners(){this.events.on("form:validation:result",t=>{this.updateFormState(t)})}setupInputChangeListeners(){this.root.querySelectorAll("input").forEach(e=>{e.addEventListener("input",()=>{this.onInputChange(e)}),e.addEventListener("select",i=>{i.stopPropagation()}),e.addEventListener("focus",i=>{i.stopPropagation()})})}onInputChange(t){const e=t.name,i=t.value;this.emitFieldChange(e,i)}handleSubmit(){this.isFormValid?this.onSubmit():this.requestValidation()}updateFormState(t){this.isFormValid=t.isValid,this.submitBtn&&(this.submitBtn.disabled=!t.isValid),this.setTextContent(".form__errors",t.errors.join(", "))}}class P{constructor(t){this.events=t,this.setupEventListeners()}address="";payment=null;setupEventListeners(){this.events.on("form:validate:step1",()=>{this.validateAndEmit()})}setAddress(t){this.address=t,this.validateAndEmit()}setPayment(t){this.payment=t,this.validateAndEmit()}validateAndEmit(){const t=this.validateStep1();this.events.emit("form:validation:result",{isValid:t.isValid,errors:t.errors,data:t.data})}validateStep1(){const t=this.address.length>=5,e=this.payment!==null,i=t&&e,s=[];return e?t||s.push("Необходимо указать адрес"):s.push("Необходимо выбрать способ оплаты"),{isValid:i,errors:s,data:{address:this.address,payment:this.payment}}}getFormData(){return{address:this.address,payment:this.payment}}}class x extends u{addressInput;paymentCardBtn;paymentCashBtn;validationModel;constructor(t){super("order",t),this.addressInput=this.root.querySelector('input[name="address"]'),this.paymentCardBtn=this.root.querySelector('button[name="card"]'),this.paymentCashBtn=this.root.querySelector('button[name="cash"]'),this.validationModel=new P(this.events),this.setupPaymentListeners()}mount(t){return this.setInputValue('input[name="address"]',t.address??""),this.initializeValidationModel(t),this.setActivePayment(t.payment??null),this.root}initializeValidationModel(t){this.validationModel.setAddress(t.address??""),this.validationModel.setPayment(t.payment??null),this.requestValidation()}setupPaymentListeners(){this.paymentCardBtn.addEventListener("click",()=>this.togglePayment("card")),this.paymentCashBtn.addEventListener("click",()=>this.togglePayment("cash"))}togglePayment(t){const i=this.getActivePayment()===t?null:t;this.setActivePayment(i),this.validationModel.setPayment(i)}setActivePayment(t){this.paymentCardBtn.classList.remove("button_alt-active"),this.paymentCashBtn.classList.remove("button_alt-active"),t==="card"?this.paymentCardBtn.classList.add("button_alt-active"):t==="cash"&&this.paymentCashBtn.classList.add("button_alt-active")}getActivePayment(){return this.paymentCardBtn.classList.contains("button_alt-active")?"card":this.paymentCashBtn.classList.contains("button_alt-active")?"cash":null}emitFieldChange(t,e){t==="address"&&this.validationModel.setAddress(e)}requestValidation(){this.events.emit("form:validate:step1")}onSubmit(){const t=this.validationModel.getFormData();this.events.emit("order:fill-step1",t)}}class M{constructor(t){this.events=t,this.setupEventListeners()}email="";phone="";setupEventListeners(){this.events.on("form:validate:contacts",()=>{this.validateAndEmit()})}setEmail(t){this.email=t,this.validateAndEmit()}setPhone(t){this.phone=t,this.validateAndEmit()}validateAndEmit(){const t=this.validateContacts();this.events.emit("form:validation:result",{isValid:t.isValid,errors:t.errors,data:t.data})}validateContacts(){const t=this.isValidEmail(this.email),e=this.isValidPhone(this.phone),i=t&&e,s=[];return!t&&this.email.length>0&&s.push("Введите корректный email"),!e&&this.phone.length>0&&s.push("Введите корректный номер телефона"),this.email.length===0&&s.push("Введите email"),this.phone.length===0&&s.push("Введите номер телефона"),{isValid:i,errors:s,data:{email:this.email,phone:this.phone}}}isValidEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}isValidPhone(t){return/^[\+]?[0-9\s\-\(\)]{10,}$/.test(t)}getFormData(){return{email:this.email,phone:this.phone}}}class A extends u{constructor(t,e){super("contacts",t),this.onOrderSubmit=e,this.emailInput=this.root.querySelector('input[name="email"]'),this.phoneInput=this.root.querySelector('input[name="phone"]'),this.validationModel=new M(this.events)}emailInput;phoneInput;validationModel;mount(t){return this.setInputValue('input[name="email"]',t.email??""),this.setInputValue('input[name="phone"]',t.phone??""),this.initializeValidationModel(t),this.root}initializeValidationModel(t){this.validationModel.setEmail(t.email??""),this.validationModel.setPhone(t.phone??""),this.requestValidation()}emitFieldChange(t,e){t==="email"?this.validationModel.setEmail(e):t==="phone"&&this.validationModel.setPhone(e)}requestValidation(){this.events.emit("form:validate:contacts")}onSubmit(){const t=this.validationModel.getFormData();this.events.emit("order:fill-step2",t),this.onOrderSubmit()}}class I extends l{constructor(t){super("success"),this.onClose=t,this.descEl=this.root.querySelector(".order-success__description"),this.closeBtn=this.root.querySelector(".order-success__close"),this.addEventListener(".order-success__close","click",()=>this.onClose())}descEl;closeBtn;mount(t){return this.setTextContent(".order-success__description",t),this.root}}class T{constructor(t){this.events=t,this.root=document.querySelector(".modal"),this.content=this.root.querySelector(".modal__content"),this.closeBtn=this.root.querySelector(".modal__close"),this.root.addEventListener("click",this.onBackdrop),this.closeBtn.addEventListener("click",()=>this.close()),t.on("modal:open",e=>{const{content:i}=e;this.open(i)}),t.on("modal:close",()=>this.close())}root;content;closeBtn;onBackdrop=t=>{t.target===this.root&&this.close()};lockBodyScroll(){document.body.style.overflow="hidden"}unlockBodyScroll(){document.body.style.overflow=""}open(t){this.content.replaceChildren(t),t.classList.contains("basket")?this.root.classList.add("modal_basket"):this.root.classList.remove("modal_basket"),this.root.classList.add("modal_active"),this.lockBodyScroll()}close(){this.root.classList.remove("modal_active","modal_basket"),this.content.replaceChildren(),this.unlockBodyScroll()}}class O{constructor(t,e,i){this.api=t,this.events=e,this.basket=new k(e),this.order=new E(e),this.mainView=new V(i,e),this.modal=new T(e),this.loadProducts(),e.on("product:select",({id:s})=>{const o=this.products.find(d=>d.id===s);if(!o)return;const a=new B(e).render(o,this.basket.has(s));this.openBasketView=null,e.emit("modal:open",{content:a})}),e.on("basket:open",()=>this.openBasket()),e.on("basket:add",({id:s})=>{const o=this.products.find(r=>r.id===s);o&&this.basket.add(o)}),e.on("basket:remove",({id:s})=>{this.basket.remove(s)}),e.on("basket:updated",({state:s})=>{if(this.openBasketView){const o=this.openBasketView.render(s.items,s.total);this.modal.open(o)}}),e.on("modal:close",()=>this.openBasketView=null),e.on("order:open-step1",()=>{const s=new x(e);this.openBasketView=null,this.modal.open(s.mount(this.order.step1))}),e.on("order:fill-step1",s=>{const o=s;if(this.order.step1={payment:o.payment,address:o.address??""},o.address?.trim().length>0&&(o.payment==="card"||o.payment==="cash")){const a=new A(e,()=>this.submitOrder());this.modal.open(a.mount(this.order.step2))}}),e.on("order:fill-step2",s=>{this.order.step2={email:s.email??"",phone:s.phone??""},this.submitOrder()}),e.on("order:success",({total:s})=>{this.basket.clear(),this.order.reset();const o=new I(()=>e.emit("modal:close"));this.openBasketView=null,this.modal.open(o.mount(`Списано ${c(s)}`))})}products=[];mainView;basket;order;modal;openBasketView=null;openBasket(){const t=new q(this.events),{items:e,total:i}=this.basket.state;this.openBasketView=t,this.events.emit("modal:open",{content:t.render(e,i)})}async loadProducts(){try{const t=await this.api.getProducts();this.products=t.items,this.events.emit("items:change",{items:this.products})}catch(t){console.error(t)}}async submitOrder(){const{items:t,total:e}=this.basket.state,i=this.order.toRequest(t.map(s=>s.id),e);try{await this.api.createOrder(i),this.events.emit("order:success",{total:i.total})}catch(s){console.error(s),this.events.emit("order:success",{total:i.total})}}}const F="",D=document.querySelector("main.gallery"),p=new m,$=new _(F);new O($,p,D);p.emit("app:init");
//# sourceMappingURL=index-Cu2fByxy.js.map
