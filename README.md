# Веб-ларёк

Интернет-магазин с товарами для веб-разработчиков: каталог, просмотр товара, корзина и двухшаговое оформление заказа.

## Стек

* **TypeScript**
* **Webpack 5** (dev-server, сборка)
* **SCSS** (БЭМ)
* **ESLint + Prettier**
* **Babel** (`preset-env`)
* **dotenv** (переменные окружения)
* Инфраструктура: `Api` (HTTP-клиент), `EventEmitter` (событийная шина)

## Быстрый старт

**Установить зависимости:**

```bash
npm i
```

**Создать `.env` в корне:**

```dotenv
API_ORIGIN=https://larek-api.nomoreparties.co
```

> **Важно:** без завершающего слэша.

**Запуск в dev-режиме:**

```bash
npm run start
```

**Сборка и разработка:**

```bash
npm run build        # production
npm run build:dev    # development
npm run watch        # наблюдение
```

**Линтинг/форматирование:**

```bash
npm run lint
npm run lint:fix
npm run format
```

## Структура проекта (основное)

```
src/
  index.ts             # точка входа (презентер в виде "сценария" приложения)
  types/
    index.ts           # интерфейсы данных (товары, корзина, заказ, события и т.д.)
  components/
    base/
      api.ts           # базовый API-клиент
      events.ts        # брокер событий (EventEmitter)
  common.blocks/       # БЭМ-блоки и стили
  scss/                # общие стили
  images/, vendor/     # ассеты и шрифты
```

## Парадигма и слои (MVP + событийная шина)

Применяется **MVP**:

* **Слой МОДЕЛЕЙ** — классы предметной области. Хранят/валидируют данные, преобразуют форматы **API→UI**, публикуют события об изменениях.
* **Слой ПРЕДСТАВЛЕНИЙ** — классы для работы с DOM. Рендерят данные, собирают пользовательские действия и генерируют UI-события. Не знают про сеть.
* **Слой ПРЕЗЕНТЕРА** — «клей» в `src/index.ts`: подписывается на события, вызывает методы моделей, передаёт данные в представления, управляет модалками.

### События (неполный список)

* `catalog:loaded`, `catalog:load-error`, `product:select`
* `basket:add`, `basket:remove`, `basket:updated`, `basket:open`
* `order:fill-step1`, `order:fill-step2`, `order:submit`, `order:success`, `order:error`
* `modal:open`, `modal:close`, `form:errors`, `form:valid`

## Классы (описание)

### Слой МОДЕЛЕЙ

#### `CatalogModel`

**Назначение:** хранит каталог, преобразует формат API → формат UI.
**Конструктор:** `(events)` — брокер событий.
**Поля:**

* `items` — массив товаров в формате UI (подготовленные данные, в т.ч. `priceLabel`).
  **Методы:**
* `setFromApi(list)` — трансформирует данные API, сохраняет в `items`, публикует `catalog:loaded`.
* `getById(id)` — вернуть товар или `undefined`.

#### `BasketModel`

**Назначение:** состояние корзины.
**Конструктор:** `(events)`.
**Поля:**

* `state.items` — `{ id, title, price }[]`
* `state.total` — сумма числовых цен (значения `null` не учитываются)
* `state.canOrder` — можно ли оформить заказ
  **Методы:**
* `add(id, title, price)` / `remove(id)` / `clear()` — изменить состав корзины, публикуют `basket:updated`.
* `has(id)` — товар в корзине?
* `calcTotal()` — пересчёт суммы.

#### `OrderModel`

**Назначение:** оформление заказа — 2 шага, валидация и сбор запроса.
**Конструктор:** `(events)`.
**Поля:**

* `step1: { payment, address }`
* `step2: { email, phone }`
  **Методы:**
* `setStep1(part)` — частично обновляет 1-й шаг; валидирует (адрес обязателен); публикует `form:errors`/`form:valid`.
* `setStep2(part)` — обновляет 2-й шаг; валидирует (email и phone обязательны); публикует `form:*`.
* `toRequest(items, total)` — формирует объект запроса к API.
* `reset()` — сброс.

### Слой ПРЕДСТАВЛЕНИЙ

#### `CatalogView`

**Назначение:** сетка карточек на главной.
**DOM-поля:** контейнер списка, шаблон карточки.
**Методы:** `render({ items })`; генерирует `product:select` при клике на карточку.

#### `CardView`

**Назначение:** отдельная карточка в каталоге.
**DOM-поля:** корневой элемент, заголовок, цена, кнопка/иконка.
**Методы:** `render(product)`; клики проксируются в `CatalogView`.

#### `PreviewView`

**Назначение:** модальное превью товара.
**DOM-поля:** изображение, название, описание, цена, кнопки «Купить/Убрать».
**Методы:** `render(product, inBasket)`; генерирует `basket:add` / `basket:remove`.

#### `BasketView`

**Назначение:** модалка корзины.
**DOM-поля:** список позиций, сумма, кнопка «Оформить».
**Методы:** `render(state)`; генерирует `order:open` (переход к шагу 1).

#### `OrderStep1View`

**Назначение:** форма «оплата + адрес».
**DOM-поля:** переключатели оплаты, поле адреса, «Далее».
**Методы:** `render(data)`; генерирует `order:fill-step1`.

#### `OrderStep2View`

**Назначение:** форма «контакты».
**DOM-поля:** поля email/phone, «Оплатить».
**Методы:** `render(data)`; генерирует `order:fill-step2` и `order:submit`.

#### `ModalView` (ОДИН класс)

**Назначение:** универсальная модалка, показывает любой переданный контент.
**Конструктор:** `(root, events)`.
**DOM-поля:** оверлей, контейнер контента, крестик.
**Методы:** `open(contentElement)`, `close()`; закрытие по клику вне и по крестику.

### Слой ПРЕЗЕНТЕРА

Реализован в `src/index.ts` как сценарий: подписки на события, вызовы методов моделей, обновление представлений, открытие/закрытие модалки. Сетевые запросы — в модели/сервисе, не в представлениях.

## Сценарий взаимодействия

**Ситуация:** пользователь нажимает «Купить» в модальном превью товара.

1. `PreviewView` ловит клик и публикует событие **`basket:add`** с `{ id }`.
2. Презентер получает `basket:add` и вызывает `BasketModel.add(id, title, price)`.
3. `BasketModel` обновляет `state.items` / `state.total` и публикует **`basket:updated`** с новым состоянием.
4. Презентер получает `basket:updated` и вызывает `BasketView.render(state)`; при необходимости обновляет `PreviewView` / `CatalogView`.
5. `BasketView` перерисовывается (позиции, сумма, активность «Оформить»).

## Данные и типы

Интерфейсы данных в `src/types/index.ts`:

* Товар из API (`IProductApi`) и товар для UI (`IProduct` с `priceLabel`)
* Позиция/состояние корзины (`IBasketItem`, `IBasketState`)
* Шаги и запрос заказа (`IOrderPart1`, `IOrderPart2`, `IOrderRequest`)
* Ответ API на заказ (`IOrderResponseApi`)
* Результаты валидации (`IValidationResult<T>`)
* События и их payload (строки-имена и карта нагрузок)

## Функциональные требования (реализуются в логике)

* **Главная:** каталог; клик по карточке — модалка; клик по иконке корзины — модалка корзины.
* **Просмотр товара:** «Купить» — добавить (если не в корзине); «Убрать» — удалить.
* **Оформление заказа:**

  * Шаг 1 — выбор оплаты (`card`/`cash`), адрес (**обязателен**).
  * Шаг 2 — email и телефон (**оба обязательны**).
  * Оплата → сообщение об успехе и очистка корзины.
* **Модалки** закрываются по клику вне и по крестику.
* **Кнопки «Далее/Оплатить»** активны только при валидных данных текущего шага.
